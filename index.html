<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üíå A Little Valentine For You</title>

  <style>
    :root{
      --bg:#0b0b12;
      --card:#151525;
      --text:#f5f5ff;
      --muted:#b9b9d6;
      --accent:#ff4d8d;
      --accent2:#7c5cff;
      color-scheme: dark;
    }
    html, body { color-scheme: dark; }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(255,77,141,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(124,92,255,.25), transparent 60%),
        linear-gradient(180deg, #07070d, #0b0b12);
      display:grid;
      place-items:center;
      padding:24px;
      overflow-x:hidden;
    }

    .wrap{ width:min(860px, 100%); }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:16px;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size:13px;
      backdrop-filter: blur(6px);
    }

    .card{
      background: rgba(21,21,37,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .hero{
      padding:26px 22px 18px;
      background:
        radial-gradient(600px 240px at 20% 20%, rgba(255,77,141,.30), transparent 60%),
        radial-gradient(600px 240px at 80% 10%, rgba(124,92,255,.25), transparent 60%);
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    h1{ margin:0 0 8px; font-size: clamp(22px, 3.2vw, 34px); }
    p{ margin:0; color: var(--muted); line-height:1.5; }

    .content{ padding:18px 22px 22px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    label{ display:block; font-size:13px; color: var(--muted); margin: 10px 0 6px; }

    input[type="text"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      -webkit-appearance: none;
      appearance: none;
    }
    textarea{ min-height: 96px; resize: vertical; }

    /* Safari dropdown readability (fallback if you still use <select>) */
    select{
      background-color: rgba(255,255,255,.08) !important;
      color: #f5f5ff !important;
    }
    option, optgroup{
      background-color:#151525 !important;
      color:#f5f5ff !important;
    }

    input:focus, textarea:focus, select:focus{
      outline: 2px solid rgba(255,77,141,.55);
      outline-offset: 2px;
    }

    .q{
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      margin-top:14px;
    }
    .qtitle{ font-weight:650; margin:0 0 4px; }
    .qsub{ margin:0 0 10px; font-size:13px; color: var(--muted); }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    button{
      border:0;
      padding:12px 14px;
      border-radius:12px;
      color:white;
      cursor:pointer;
      font-weight:650;
    }
    .primary{ background: linear-gradient(90deg, var(--accent), #ff7aa9); }
    .secondary{ background: rgba(255,255,255,.10); }
    .ghost{ background: transparent; border: 1px solid rgba(255,255,255,.18); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .progress{
      height:10px;
      background: rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .35s ease;
    }
    .small{ font-size:12px; color: var(--muted); margin-top:8px; }
    .hidden{ display:none; }

    /* Choice cards (Safari-proof) */
    .choices{ display:grid; gap:10px; margin-top:10px; }
    .choice{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
    }
    .choice:hover{ background: rgba(255,255,255,.09); }
    .choice input{
      width:18px;
      height:18px;
      accent-color: var(--accent);
      flex: 0 0 auto;
    }

    .final{
      padding: 18px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 240px at 20% 20%, rgba(255,77,141,.20), transparent 60%),
        radial-gradient(600px 240px at 80% 10%, rgba(124,92,255,.18), transparent 60%),
        rgba(255,255,255,.03);
      margin-top: 16px;
    }
    .loveTitle{
      margin: 4px 0 8px;
      font-size: clamp(20px, 3vw, 30px);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .loveMsg{
      margin: 0 0 10px;
      color: rgba(255,255,255,.85);
      line-height: 1.55;
      font-size: 15px;
    }

    .copybox{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .footer{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: rgba(255,255,255,.45);
      font-size:12px;
    }
    .statusPill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
      font-size:12px;
      margin-top:10px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(255,255,255,.35);
    }
    .dot.ok{ background: rgba(0,255,128,.75); }
    .dot.warn{ background: rgba(255,196,0,.85); }

    /* Top-right fixed restart */
    .restartFixed{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 20;
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* Sparkle overlay */
    #sparkleLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .sparkle{
      position:absolute;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      box-shadow: 0 0 12px rgba(255,255,255,.9);
      opacity: 0;
      transform: translate3d(0,0,0);
      animation: sparkleFloat 1200ms ease-in-out forwards;
    }
    @keyframes sparkleFloat{
      0%   { opacity: 0; transform: translate3d(0,0,0) scale(.6); }
      20%  { opacity: 1; }
      60%  { opacity: .9; }
      100% { opacity: 0; transform: translate3d(var(--dx), var(--dy), 0) scale(1.4); }
    }
    .sparkleFadeOut{
      animation: layerFade 700ms ease forwards;
    }
    @keyframes layerFade{
      from { opacity: 1; }
      to   { opacity: 0; }
    }
  </style>
</head>

<body>
  <!-- Sparkles -->
  <div id="sparkleLayer" aria-hidden="true"></div>

  <!-- Always-visible restart -->
  <div class="restartFixed">
    <button class="ghost" id="restartGlobalBtn">Restart ‚Üª</button>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="badge">üíó Valentine Mini-Site</div>
      <div class="badge" id="attemptBadge">Attempt: #1</div>
    </div>

    <div class="card">
      <div class="hero">
        <h1 id="title">Hi my love üíå</h1>
        <p id="subtitle">Answer a few questions and unlock a surprise at the end.</p>
        <div style="margin-top:14px" class="progress" aria-label="Progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="small" id="stepText">Step 1 of 6</div>
      </div>

      <div class="content">
        <!-- Step 1 -->
        <section class="step" data-step="1">
          <div class="row">
            <div style="flex:1 1 240px">
              <label>Your name</label>
              <input id="herName" type="text" placeholder="Type your name" />
            </div>
            <div style="flex:1 1 240px">
              <label>Today‚Äôs vibe</label>
              <select id="vibe">
                <option value="">Pick one</option>
                <option>Soft & cozy</option>
                <option>Chaotic cute</option>
                <option>Romantic mood</option>
                <option>Laughing all day</option>
                <option>Missing you</option>
              </select>
            </div>
          </div>

          <div class="q">
            <div class="qtitle">Quick promise ü§ù</div>
            <p class="qsub">Answer honestly (and cutely). No wrong answers.</p>
            <label style="margin-top:8px">
              <input id="promise" type="checkbox" style="accent-color: var(--accent);" />
              I promise üòå
            </label>
          </div>
        </section>

        <!-- Step 2 -->
        <section class="step hidden" data-step="2">
          <div class="q">
            <div class="qtitle">1) Pick our cutest memory</div>
            <p class="qsub">Choose one (you can tell me the full story later üò≠)</p>

            <div class="choices">
              <label class="choice"><input type="radio" name="memory" value="Our first proper date"> Our first proper date</label>
              <label class="choice"><input type="radio" name="memory" value="That time we laughed non-stop"> That time we laughed non-stop</label>
              <label class="choice"><input type="radio" name="memory" value="A simple moment that felt perfect"> A simple moment that felt perfect</label>
              <label class="choice"><input type="radio" name="memory" value="A surprise / unexpected moment"> A surprise / unexpected moment</label>
              <label class="choice"><input type="radio" name="memory" value="Other (I‚Äôll tell you later)"> Other (I‚Äôll tell you later)</label>
            </div>
          </div>
        </section>

        <!-- Step 3 -->
        <section class="step hidden" data-step="3">
          <div class="q">
            <div class="qtitle">2) When you think of me, what‚Äôs the first word?</div>
            <p class="qsub">Pick one üòå</p>

            <select id="q2">
              <option value="">Pick one</option>
              <option>Home</option>
              <option>Peace</option>
              <option>Comfort</option>
              <option>Funny</option>
              <option>Safe</option>
              <option>Love</option>
              <option>Best</option>
              <option>Crazy (in a good way)</option>
            </select>
          </div>
        </section>

        <!-- Step 4 -->
        <section class="step hidden" data-step="4">
          <div class="q">
            <div class="qtitle">3) Choose our next date idea</div>
            <p class="qsub">Pick one ‚Äî we‚Äôll do it soon.</p>

            <div class="choices">
              <label class="choice"><input type="radio" name="dateIdea" value="Food + long talk"> Food + long talk</label>
              <label class="choice"><input type="radio" name="dateIdea" value="Movie night + snacks"> Movie night + snacks</label>
              <label class="choice"><input type="radio" name="dateIdea" value="Picnic / sunset"> Picnic / sunset</label>
              <label class="choice"><input type="radio" name="dateIdea" value="Game night (I‚Äôll lose on purpose)"> Game night (I‚Äôll lose on purpose)</label>
              <label class="choice"><input type="radio" name="dateIdea" value="Surprise date (you choose everything)"> Surprise date (you choose everything)</label>
            </div>
          </div>
        </section>

        <!-- Step 5 -->
        <section class="step hidden" data-step="5">
          <div class="q">
            <div class="qtitle">4) One thing you want more of from me</div>
            <p class="qsub">Choose as many as you want.</p>

            <div class="choices">
              <label class="choice"><input type="checkbox" name="moreOf" value="More time together"> More time together</label>
              <label class="choice"><input type="checkbox" name="moreOf" value="More communication"> More communication</label>
              <label class="choice"><input type="checkbox" name="moreOf" value="More reassurance"> More reassurance</label>
              <label class="choice"><input type="checkbox" name="moreOf" value="More surprise dates"> More surprise dates</label>
              <label class="choice"><input type="checkbox" name="moreOf" value="More hugs / affection"> More hugs / affection</label>
              <label class="choice"><input type="checkbox" name="moreOf" value="More jokes (don‚Äôt judge me)"> More jokes (don‚Äôt judge me)</label>
            </div>
          </div>

          <div class="q">
            <div class="qtitle">Bonus: Pick a ‚Äúkiss level‚Äù üò≥</div>
            <p class="qsub">This is important research.</p>

            <div class="choices">
              <label class="choice"><input type="radio" name="kiss" value="1" /> 1 ‚Äî shy</label>
              <label class="choice"><input type="radio" name="kiss" value="2" /> 2 ‚Äî cute</label>
              <label class="choice"><input type="radio" name="kiss" value="3" /> 3 ‚Äî dangerous</label>
              <label class="choice"><input type="radio" name="kiss" value="4" /> 4 ‚Äî criminal</label>
            </div>
          </div>
        </section>

        <!-- Step 6 -->
        <section class="step hidden" data-step="6">
          <div class="final">
            <div class="loveTitle" id="loveTitle">Unlocked ‚ú®</div>
            <p class="loveMsg" id="loveMsg"></p>

            <div class="statusPill" id="submitStatus">
              <span class="dot warn" id="submitDot"></span>
              <span id="submitText">Sending your answers‚Ä¶</span>
            </div>

            <div class="copybox" id="summary"></div>

            <div class="actions">
              <button class="primary" id="copyBtn">Copy summary</button>
              <button class="secondary" id="restartBtnFinal">Restart</button>
            </div>
          </div>
        </section>

        <div class="actions">
          <button class="secondary" id="backBtn">Back</button>
          <button class="primary" id="nextBtn">Next</button>
        </div>

        <div class="footer">
          <div>Tip: Works on Safari (iPhone) + Chrome.</div>
          <div id="hint"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  /***************
   * CONFIG YOU MUST SET FOR GOOGLE FORMS
   ***************/
  // 1) Replace with your Google Form formResponse URL:
  // Example: https://docs.google.com/forms/d/e/FORM_ID/formResponse
  const FORM_RESPONSE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfV5TPpSQIbB4fOGfiYLrH4rSC2wThjxDuYz8RoAo6zx8A6Gg/formResponse";

  // 2) Add these questions to your Google Form and paste each entry id:
  //    - Attempt ID (short answer)
  //    - Attempt Number (short answer)
  //    - Attempt Status (short answer) => "completed" or "abandoned"
  //    - Started At (short answer)
  //    - Submitted At (short answer)
  //
  // Then paste the entry.xxxxx for each.
  const ENTRY = {
    attemptId:     "entry.1111111111",
    attemptNumber: "entry.2222222222",
    status:        "entry.3333333333",
    startedAt:     "entry.4444444444",
    submittedAt:   "entry.5555555555",

    herName:       "entry.6666666666",
    vibe:          "entry.7777777777",
    promise:       "entry.8888888888",

    memory:        "entry.9999999999",
    firstWord:     "entry.1010101010",
    dateIdea:      "entry.1111111112",
    moreOf:        "entry.1313131313",
    kiss:          "entry.1414141414"
  };

  /***************
   * PERSONALIZE
   ***************/
  const YOUR_NAME = "Shenal";
  const HER_NICKNAME = "my love";

  /***************
   * APP STATE
   ***************/
  const steps = Array.from(document.querySelectorAll(".step"));
  const bar = document.getElementById("bar");
  const stepText = document.getElementById("stepText");
  const title = document.getElementById("title");
  const subtitle = document.getElementById("subtitle");
  const hint = document.getElementById("hint");
  const attemptBadge = document.getElementById("attemptBadge");

  const backBtn = document.getElementById("backBtn");
  const nextBtn = document.getElementById("nextBtn");

  const restartGlobalBtn = document.getElementById("restartGlobalBtn");
  const restartBtnFinal = document.getElementById("restartBtnFinal");

  const herName = document.getElementById("herName");
  const vibe = document.getElementById("vibe");
  const promise = document.getElementById("promise");
  const q2 = document.getElementById("q2");

  const loveTitle = document.getElementById("loveTitle");
  const loveMsg = document.getElementById("loveMsg");
  const summaryBox = document.getElementById("summary");

  const submitStatus = document.getElementById("submitStatus");
  const submitDot = document.getElementById("submitDot");
  const submitText = document.getElementById("submitText");

  const copyBtn = document.getElementById("copyBtn");

  const STORAGE_KEY = "valentine_attempts_v1";
  const ATTEMPT_NUM_KEY = "valentine_attempt_number_v1";

  let currentStep = 1;

  // Current attempt tracking
  let attemptId = "";
  let attemptNumber = 1;
  let startedAtISO = "";
  let hasSubmittedThisAttempt = false;

  /***************
   * HELPERS
   ***************/
  const $qs = (sel) => document.querySelector(sel);
  const $qsa = (sel) => Array.from(document.querySelectorAll(sel));

  function uuid() {
    // simple uuid-ish
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
      const r = (Math.random() * 16) | 0;
      const v = c === "x" ? r : (r & 0x3) | 0x8;
      return v.toString(16);
    });
  }

  function nowISO() { return new Date().toISOString(); }

  function getRadioValue(name) {
    const r = document.querySelector(`input[name="${name}"]:checked`);
    return r ? r.value : "";
  }
  function setRadioValue(name, val) {
    const r = document.querySelector(`input[name="${name}"][value="${CSS.escape(val)}"]`);
    if (r) r.checked = true;
  }
  function getCheckboxValues(name) {
    return $qsa(`input[name="${name}"]:checked`).map(x => x.value);
  }
  function setCheckboxValues(name, vals) {
    const set = new Set(vals || []);
    $qsa(`input[name="${name}"]`).forEach(cb => cb.checked = set.has(cb.value));
  }

  function updateHeader() {
    const percent = ((currentStep - 1) / (steps.length - 1)) * 100;
    bar.style.width = `${percent}%`;
    stepText.textContent = `Step ${currentStep} of ${steps.length}`;

    const nm = (herName.value || HER_NICKNAME).trim();
    title.textContent = `Hi ${nm} üíå`;

    const vibeText = vibe.value ? `Today‚Äôs vibe: ${vibe.value}.` : "";
    subtitle.textContent = `Answer a few questions and unlock a surprise at the end. ${vibeText}`.trim();

    const hints = {
      1: "Tick the promise box to continue üòâ",
      2: "Pick a memory‚Ä¶ no pressure ü•∫",
      3: "Pick one word üòå",
      4: "Choose wisely‚Ä¶ it‚Äôs a contract üòÇ",
      5: "Pick at least one + kiss level üò≥",
      6: "Love message unlocked üíó"
    };
    hint.textContent = hints[currentStep] || "";
  }

  function showStep(n) {
    steps.forEach(s => s.classList.add("hidden"));
    const target = steps.find(s => Number(s.dataset.step) === n);
    if (target) target.classList.remove("hidden");

    backBtn.disabled = (n === 1);
    nextBtn.textContent = (n === steps.length) ? "Done" : "Next";

    updateHeader();
    validate();
  }

  function validate() {
    let ok = true;

    if (currentStep === 1) {
      ok = promise.checked;
    } else if (currentStep === 2) {
      ok = getRadioValue("memory") !== "";
    } else if (currentStep === 3) {
      ok = q2.value !== "";
    } else if (currentStep === 4) {
      ok = getRadioValue("dateIdea") !== "";
    } else if (currentStep === 5) {
      ok = getCheckboxValues("moreOf").length >= 1 && getRadioValue("kiss") !== "";
    }

    nextBtn.disabled = !ok;
    return ok;
  }

  function collectData() {
    // IMPORTANT: unanswered questions return "" or [] to become "null/blank" in Google Forms
    return {
      attemptId,
      attemptNumber,
      startedAt: startedAtISO,
      herName: herName.value.trim(),
      vibe: vibe.value || "",
      promise: promise.checked ? "true" : "false",
      memory: getRadioValue("memory") || "",
      firstWord: q2.value || "",
      dateIdea: getRadioValue("dateIdea") || "",
      moreOf: getCheckboxValues("moreOf"), // [] becomes blank
      kiss: getRadioValue("kiss") || ""
    };
  }

  function buildSummary(status) {
    const d = collectData();
    const kissMap = { "1":"shy", "2":"cute", "3":"dangerous", "4":"criminal" };

    return (
`Attempt #${d.attemptNumber} (${status})
Attempt ID: ${d.attemptId}
Started: ${d.startedAt}

Name: ${d.herName || "(blank)"}
Vibe: ${d.vibe || "(blank)"}
Promise: ${d.promise}

1) Memory: ${d.memory || "(blank)"}
2) First word: ${d.firstWord || "(blank)"}
3) Date idea: ${d.dateIdea || "(blank)"}
4) More of: ${d.moreOf.length ? d.moreOf.join(", ") : "(blank)"}
5) Kiss level: ${d.kiss ? `${d.kiss} ‚Äî ${kissMap[d.kiss]}` : "(blank)"}`
    );
  }

  function setSubmitUI(state) {
    // state: "sending" | "sent" | "skipped"
    submitStatus.style.display = "inline-flex";
    if (state === "sending") {
      submitDot.className = "dot warn";
      submitText.textContent = "Sending your answers‚Ä¶";
    } else if (state === "sent") {
      submitDot.className = "dot ok";
      submitText.textContent = "Saved to my Google Form ‚úÖ";
    } else {
      submitDot.className = "dot warn";
      submitText.textContent = "Google Form not configured yet.";
    }
  }

  /***************
   * GOOGLE FORMS SUBMIT
   ***************/
  function isGoogleConfigured() {
    return FORM_RESPONSE_URL.startsWith("https://docs.google.com/forms/") && Object.values(ENTRY).every(v => v.startsWith("entry."));
  }

  function toUrlEncoded(paramsObj) {
    const data = new URLSearchParams();

    // Always include attempt metadata and status
    data.append(ENTRY.attemptId, paramsObj.attemptId || "");
    data.append(ENTRY.attemptNumber, String(paramsObj.attemptNumber || ""));
    data.append(ENTRY.status, paramsObj.status || "");
    data.append(ENTRY.startedAt, paramsObj.startedAt || "");
    data.append(ENTRY.submittedAt, paramsObj.submittedAt || "");

    // Answers (blank allowed)
    data.append(ENTRY.herName, paramsObj.herName || "");
    data.append(ENTRY.vibe, paramsObj.vibe || "");
    data.append(ENTRY.promise, paramsObj.promise || "");

    data.append(ENTRY.memory, paramsObj.memory || "");
    data.append(ENTRY.firstWord, paramsObj.firstWord || "");
    data.append(ENTRY.dateIdea, paramsObj.dateIdea || "");
    data.append(ENTRY.moreOf, (paramsObj.moreOf && paramsObj.moreOf.length) ? paramsObj.moreOf.join(", ") : "");
    data.append(ENTRY.kiss, paramsObj.kiss || "");

    return data.toString();
  }

  function submitAttempt(status, reason) {
    // Prevent double submit for same attempt
    if (hasSubmittedThisAttempt) return;
    hasSubmittedThisAttempt = true;

    const d = collectData();
    const submittedAtISO = nowISO();

    const payload = {
      ...d,
      status,               // "completed" or "abandoned"
      submittedAt: submittedAtISO,
      reason: reason || ""  // not sent unless you add field; just kept locally
    };

    // Save attempt locally (record every attempt)
    const raw = localStorage.getItem(STORAGE_KEY);
    const list = raw ? JSON.parse(raw) : [];
    list.push(payload);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

    // If Google Form isn't configured, stop here
    if (!isGoogleConfigured()) return;

    const body = toUrlEncoded(payload);

    // Try sendBeacon first (best for unload/close)
    let beaconOk = false;
    try {
      if (navigator.sendBeacon) {
        const blob = new Blob([body], { type: "application/x-www-form-urlencoded" });
        beaconOk = navigator.sendBeacon(FORM_RESPONSE_URL, blob);
      }
    } catch {}

    // If not beacon, use fetch no-cors (works for normal submit)
    if (!beaconOk) {
      fetch(FORM_RESPONSE_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body,
        keepalive: true
      }).catch(() => {});
    }
  }

  /***************
   * ATTEMPT MANAGEMENT
   ***************/
  function startNewAttempt() {
    attemptNumber = Number(localStorage.getItem(ATTEMPT_NUM_KEY) || "0") + 1;
    localStorage.setItem(ATTEMPT_NUM_KEY, String(attemptNumber));

    attemptId = uuid();
    startedAtISO = nowISO();
    hasSubmittedThisAttempt = false;

    attemptBadge.textContent = `Attempt: #${attemptNumber}`;
  }

  function resetInputs() {
    herName.value = "";
    vibe.value = "";
    promise.checked = false;

    $qsa('input[type="radio"]').forEach(r => r.checked = false);
    $qsa('input[type="checkbox"]').forEach(c => c.checked = false);
    q2.value = "";
  }

  function restartFlow() {
    // Submit current attempt as abandoned (blanks allowed)
    submitAttempt("abandoned", "restart");
    // New attempt
    startNewAttempt();
    resetInputs();
    currentStep = 1;
    showStep(currentStep);
  }

  /***************
   * FINAL (STEP 6)
   ***************/
  function showFinalAndSubmit() {
    const nm = (herName.value || HER_NICKNAME).trim();
    const word = q2.value || "everything";
    const date = getRadioValue("dateIdea") || "a date";

    loveTitle.textContent = "I choose you üíó";
    loveMsg.textContent =
      `${nm}, thank you for doing this ü•∫. You picked ‚Äú${word}‚Äù for me and I‚Äôm genuinely smiling like an idiot. ` +
      `Our next plan is: ${date}. Just remember ‚Äî you‚Äôre my favorite person, always.`;

    // Summary for user
    summaryBox.textContent = buildSummary("completed");

    // Submit to Google Form
    if (isGoogleConfigured()) {
      setSubmitUI("sending");
      submitAttempt("completed", "finish");
      // We can't read response because no-cors, so we show "sent" after a short delay
      setTimeout(() => setSubmitUI("sent"), 700);
    } else {
      setSubmitUI("skipped");
    }
  }

  /***************
   * SPARKLES (5s)
   ***************/
  function runSparkles(durationMs = 5000) {
    const layer = document.getElementById("sparkleLayer");
    if (!layer) return;

    const start = performance.now();
    const spawnEveryMs = 90; // density
    let lastSpawn = 0;

    function spawnOne() {
      const s = document.createElement("div");
      s.className = "sparkle";

      const x = Math.random() * window.innerWidth;
      const y = Math.random() * window.innerHeight;

      const dx = (Math.random() * 2 - 1) * 120 + "px";
      const dy = (Math.random() * 2 - 1) * 120 + "px";

      s.style.left = x + "px";
      s.style.top = y + "px";
      s.style.setProperty("--dx", dx);
      s.style.setProperty("--dy", dy);

      // Slight size variety
      const size = 4 + Math.random() * 4;
      s.style.width = size + "px";
      s.style.height = size + "px";

      layer.appendChild(s);
      setTimeout(() => s.remove(), 1400);
    }

    function tick(t) {
      if (t - start >= durationMs) {
        layer.classList.add("sparkleFadeOut");
        setTimeout(() => layer.remove(), 800);
        return;
      }
      if (t - lastSpawn >= spawnEveryMs) {
        lastSpawn = t;
        // burst
        for (let i = 0; i < 3; i++) spawnOne();
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  /***************
   * EVENTS
   ***************/
  document.addEventListener("input", () => validate());
  document.addEventListener("change", () => validate());

  backBtn.addEventListener("click", () => {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  nextBtn.addEventListener("click", () => {
    if (!validate()) return;

    if (currentStep < steps.length) {
      currentStep++;

      if (currentStep === steps.length) {
        showFinalAndSubmit();
      }

      showStep(currentStep);
    }
  });

  restartGlobalBtn.addEventListener("click", restartFlow);
  restartBtnFinal.addEventListener("click", restartFlow);

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(summaryBox.textContent);
      copyBtn.textContent = "Copied ‚úÖ";
      setTimeout(() => copyBtn.textContent = "Copy summary", 1200);
    } catch {
      alert("Copy failed. You can manually select and copy the text.");
    }
  });

  // If user closes/leaves before finishing, submit abandoned with blanks.
  window.addEventListener("pagehide", () => {
    if (!hasSubmittedThisAttempt) submitAttempt("abandoned", "pagehide");
  });

  /***************
   * INIT
   ***************/
  startNewAttempt();
  showStep(currentStep);
  runSparkles(5000);
</script>
</body>
</html>
